= Техническое описание: UART Packet Parser

== Описание компонента

Данный компонент представляет собой прошивку для микроконтроллера STM32, которая реализует прием и парсинг пакетов данных по протоколу PRD-3 через интерфейс UART1. Компонент использует конечный автомат (FSM) для надежного парсинга пакетов и кольцевой буфер для приема данных.

== Основные функции

=== 1. Прием данных через UART

* Асинхронный прием данных через UART1 с использованием прерываний
* Кольцевой буфер (ring buffer) для хранения входящих данных
* Размер буфера: 512 байт

=== 2. Парсинг пакетов по протоколу PRD-3

* Конечный автомат (FSM) для последовательного парсинга пакета
* Проверка синхрослов (`SYNC1 = 0xAC`, `SYNC2 = 0x53`)
* Валидация длины пакета (4–256 байт)
* Извлечение полей пакета (SQN, ADDR, DATA, CRC)

=== 3. Валидация пакетов

* Вычисление и проверка контрольной суммы CRC8 (полином `0x31`)
* Валидация длины пакета
* Проверка последовательности байт

=== 4. Обработка типов пакетов

* Извлечение G-code команд (флаг `0x01`)
* Обработка запросов телеметрии (флаг `0x02`)
* Определение неизвестных типов пакетов

=== 5. Защита от таймаутов

* Таймаут парсера: 25 мс
* Автоматический сброс состояния при таймауте
* Защита от зависания при неполных пакетах

== Структура данных

=== Состояние конечного автомата

[source,c]
----
static uint8_t fsm_state = 0;
/*
  0 = WAIT_SYNC1
  1 = WAIT_SYNC2
  2 = WAIT_LEN
  3 = WAIT_SEQ
  4 = WAIT_ADDR
  5 = WAIT_DATA
  6 = WAIT_CRC
*/
----

=== Кольцевой буфер UART

[source,c]
----
static uint8_t  uart_ring[UART_RING_SIZE];
static volatile uint16_t uart_head = 0;
static volatile uint16_t uart_tail = 0;
----

=== Буфер данных пакета

[source,c]
----
static uint8_t data_buf[MAX_PACKET_LEN];
static uint8_t data_cnt = 0;
static uint8_t data_len_expected = 0;
----

=== Поля пакета

[source,c]
----
static uint8_t pkt_len_total = 0;
static uint8_t pkt_seq = 0;
static uint8_t pkt_addr = 0;
static uint8_t pkt_crc = 0;
----

== Формат пакета PRD-3

[source,text]
----
[SYNC1] [SYNC2] [LEN] [SQN] [ADDR] [DATA...] [CRC]
----

== Алгоритм работы

. Инициализация периферии и UART
. Основной цикл обработки
. Прием байтов по прерыванию
. Парсинг пакета конечным автоматом
. Валидация и обработка данных

== Функции

* `HAL_UART_RxCpltCallback`
* `uart_poll_process`
* `parser_process_byte`
* `parser_check_timeout`
* `crc8_calc`

== Настройки UART

* **Интерфейс:** USART1
* **Скорость:** 9600 бод
* **Формат:** 8N1
* **Режим:** TX/RX
* **Прерывания:** включены

== Зависимости

* STM32 HAL Library