= Техническое описание: Control and Testing Equipment (CaTE)

== Описание компонента

Данный компонент представляет собой программное обеспечение для управления и тестирования CNC станка.
Компонент работает в режиме *master* (ведущее устройство) и обеспечивает:

* Отправку команд G-code через протокол PRD-3
* Прием ответных пакетов от worker-нод
* Логирование телеметрии в CSV файлы
* Валидацию протокола обмена данными

== Основные функции

=== 1. Управление COM-портом

* Автоматическое обнаружение доступных COM-портов
* Настройка параметров последовательного порта (скорость, биты данных, стоп-биты)
* Управление таймаутами приема/передачи

=== 2. Отправка пакетов данных

* Формирование пакетов по протоколу PRD-3
* Добавление синхрослов, заголовков и контрольных сумм
* Последовательная отправка команд G-code из файла
* Управление счетчиком кадров (SQN)

=== 3. Прием ответных пакетов

* Прием и парсинг ответных пакетов от worker-нод
* Валидация синхрослов и структуры пакета
* Проверка последовательности пакетов (SQN)
* Валидация контрольных сумм CRC

=== 4. Обработка кодов подтверждения (ACK)

* Интерпретация кодов подтверждения:
** `0` - команда принята и декодирована
** `1` - неверный адрес устройства
** `2` - ошибка CRC
** `3` - недопустимый параметр команды
* Обработка ошибок и повторная отправка при необходимости

=== 5. Логирование телеметрии

* Запись метаданных в CSV файлы
* Автоматическое именование файлов с временной меткой
* Формат имени файла: `test_YYYY_MM_DD_HH_MM_SS.csv`

=== 6. Чтение G-code из файла

* Загрузка G-code команд из текстового файла
* Последовательная отправка команд
* Поддержка многострочных файлов

== Структура классов

=== C_COM_P_MASTER

Основной класс для работы с COM-портом и протоколом PRD-3.

==== Параметры инициализации

* `port` - имя COM-порта
* `baudrate` - скорость передачи (по умолчанию 9600)
* `bytesize` - количество бит данных (по умолчанию 8)
* `stopbits` - количество стоп-бит (по умолчанию 1)
* `timeout` - таймаут приема (по умолчанию 5 сек)
* `crc` — функция вычисления CRC

==== Основные методы

* `send_packet(LEN, CMD, PARAM)`
* `get_packet()`
* `write_csv()`
* `close()`

=== C_DATA_ITERATOR

Класс для последовательного чтения G-code команд из файла.

==== Основные методы

* `next_data()`

== Формат пакета PRD-3

=== Исходящий пакет (от master)

[source,text]
----
[SYNC1] [SYNC2] [LEN] [SQN] [ADDR] [CMD] [PARAM...] [CRC]
----

=== Входящий пакет (ответ от worker)

[source,text]
----
[SYNC1] [SYNC2] [LEN] [SQN] [ADDR] [ACK] [DATA...] [CRC]
----

== Коды подтверждения (ACK)

* **0** - команда принята
* **1** - неверный адрес устройства
* **2** - ошибка CRC
* **3** - недопустимый параметр команды

== Контрольная сумма CRC

* **Алгоритм:** CRC8
* **Полином:** `0x31 (x^8 + x^5 + x^4 + 1)`
* **Библиотека:** `crcmod.predefined`
* **Область расчета:** все байты пакета начиная с `LEN` (без CRC)

== Командная строка

[source,bash]
----
python CaTE_25_12_12.py [опции]
----

=== Опции

* `--whatcomport` - показать доступные COM-порты
* `--comportname <name>` - имя COM-порта
* `--baudrate <rate>` - скорость передачи
* `--bytesize <size>` - количество бит данных
* `--stopbits <bits>` - количество стоп-бит
* `--timeout <seconds>` - таймаут
* `--filename <path>` - файл с G-code

== Формат CSV логов

[source,csv]
----
id,SQN,metadata
1,0x00,0x12345678
2,0x01,0xABCDEF00
----

== Зависимости

* pyserial
* bitstring
* crcmod
* argparse
* datetime
* csv

== Особенности реализации

* Проверка корректности длины пакета
* Валидация синхрослов
* Проверка последовательности пакетов (SQN)
* Валидация CRC
* Накопление метаданных для логирования
* Поддержка Windows и Linux/macOS

